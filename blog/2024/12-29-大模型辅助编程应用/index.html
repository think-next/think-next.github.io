<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> 大模型辅助编程应用 | 渐行渐远</title>
  <link rel = 'canonical' href = 'https://neojos.com/blog/2024/12-29-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%85%E5%8A%A9%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:url" content="https://neojos.com/blog/2024/12-29-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%BE%85%E5%8A%A9%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8/">
  <meta property="og:site_name" content="渐行渐远">
  <meta property="og:title" content="大模型辅助编程应用">
  <meta property="og:description" content="有">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-12-29T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-29T00:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="大模型辅助编程应用">
  <meta name="twitter:description" content="有">

  
  
    
  
  
  <link rel="stylesheet" href="https://neojos.com/css/styles.2623c974144d1beb9505a943ef236d6fa1c789dd5fec28224fe04680816554cdf209a7728e9e6e879dfbc3bd4bf56b8bddee9548e671887d0e1104b34194c0d7.css" integrity="sha512-JiPJdBRNG&#43;uVBalD7yNtb6HHid1f7CgiT&#43;BGgIFlVM3yCadyjp5uh537w71L9WuL3e6VSOZxiH0OEQSzQZTA1w=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://neojos.com/images/favicon.ico" />

  
  
  
    
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=false"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'false');
        }
      </script>
    
  


  
  
</head>

<style>
  .timeline {
    position: relative;
    padding: 0;
    list-style-type: none;
    margin-left: 20px;
  }
  
  .timeline:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #ccc;
    left: 0;
  }
  
  .timeline li {
    position: relative;
    padding: 1rem 0;
  }
  
  .timeline li .timeline-badge {
    width: 20px;
    height: 20px;
    line-height: 20px;
    font-size: 1.0em;
    text-align: center;
    position: absolute;
    top: 16px;
    left: -10px;
    background-color: #999;
    border-radius: 50%;
    z-index: 100;
  }
  
  .timeline li .timeline-panel {
    width: calc(100% - 40px);
    float: right;
    padding: 1rem;
    position: relative;
    text-align: left;
    background-color: #fff;
    border: 1px solid #d4d4d4;
    border-radius: 2px;
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
  }
  
  .timeline li .timeline-panel:before {
    right: auto;
    left: -15px;
    border-top: 15px solid transparent;
    border-left: 15px solid #ccc;
    border-right: 0 solid #ccc;
    border-bottom: 15px solid transparent;
    position: absolute;
    top: 26px;
  }
  
  .timeline li .timeline-panel:after {
    right: auto;
    left: -14px;
    border-top: 14px solid transparent;
    border-left: 14px solid #fff;
    border-right: 0 solid #fff;
    border-bottom: 14px solid transparent;
    position: absolute;
    top: 27px;
  }

   
  .timeline li:nth-child(odd) .timeline-badge {
    background-color: #f0ad4e;
  }
  
  .timeline li:nth-child(even) .timeline-badge {
    background-color: #5cb85c;
  }

   
  :root {
    --color-array: #f0ad4e, #5cb85c, #5bc0de, #d9534f, #337ab7;
  }

   
  .timeline li:nth-child(1) .timeline-badge { background-color: #f0ad4e; }
  .timeline li:nth-child(2) .timeline-badge { background-color: #5cb85c; }
  .timeline li:nth-child(3) .timeline-badge { background-color: #5bc0de; }
  .timeline li:nth-child(4) .timeline-badge { background-color: #d9534f; }
  .timeline li:nth-child(5) .timeline-badge { background-color: #337ab7; }
</style>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://neojos.com/">
  
    <div id="logo" style="background-image: url(https://neojos.com/img/mifeng.jpeg)"></div>
  
  <div id="title">
    <h1>渐行渐远</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
        <li><a href="/">我的博客</a></li>
      
        <li><a href="/blog">技术</a></li>
      
        <li><a href="/greatperson">生活</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <h1 class="subheading">大模型辅助编程应用</h1>
  <span  class="blog-single-desc">Posted by 付辉 on Sunday, December 29, 2024
    共2283字
  <div class="separator"></div>
</span>

  <div class="content" itemprop="articleBody">
  
    <p>有下面的开源模型供参考：</p>
<ol>
<li>Salesforce AI Research发布的Codegen</li>
<li>Llama Code</li>
<li>Stability AI公司发布的Stable Code 3B模型，代码补齐模型</li>
</ol>
<p>模型内部的渐进式生成方案：按照 max_new_token 设定的长度限制，先生成一小段内容，推送给客户端显示，然后将之前生成的全部内容作为参数，继续调用模型的generate方法生成接下来的内容。（这里存在概念上的歧义）</p>
<p>关于代码参考的素材，我们首先可以确定的是当前的文件，在当前文件内搜索与当前编辑内容最相关的内容，其次相关的内容包括：</p>
<ul>
<li>文件的打开历史、或者说是工作区打开的tab页</li>
<li>git提交记录中的变更文件</li>
<li>import语法块中文件</li>
</ul>
<p>关于训练模型，其实并不是一件简单的事情，要训练一个Coding模型，单靠学习代码并不足以微调模型一边有效地生成代码，模型还需要其它领域的知识。而所学内容的类型和比例，我们称之为数据配比，将直接决预训练模型的最终效果。</p>
<p>这让我想到模型的评测指标，评测一个模型在不同方面的打分</p>
<h2 id="知识库rag">知识库RAG</h2>
<p>Retrieval-Augmentd Generation 检索增强生成框架，该框架可以使模型访问超出其训练数据范围之外的信息，使模型在每次生成时可以利用检索提供的外部更专业、更准确的知识，从而更好的回答用户的问题。</p>
<p>RAG是LLM内容生成的补充和完善，LLM存在的问题列举：</p>
<ol>
<li>知识更新问题，LLM通过海量的文本训练后，将这些文本以一种黑盒的方式压缩到模型自身的参数中。但这些预训练预料库内容都截止在固定的时间之前，在模型训练之后更新的知识无法囊括在大模型中。</li>
<li>训练成本问题。LLM训练硬件资源成本不需要在强调了，这里强调软件方面，对于一个大模型来说，更新基础知识库是非常困难的一件事。首先，要保证预训练数据的质量；其次，更新知识库后的模型都需要重新训练，至少需要将新数据和旧数据按照一定的比例进行混合训练，而不能仅仅使用新数据，否则会出现灾难性遗忘</li>
<li>生成结果的不可解释性问题</li>
</ol>
<p>RAG在推理过程中分为两个阶段：检索和内容生成。</p>
<ol>
<li>检索阶段，通过算法检索和用户问题相关的知识片段，这里的知识片段就可以是企业私有的仓库；</li>
<li>内容生成阶段。完成检索后，获取到了用户输入相关的可靠外部输入。在内容生成阶段，通过一个结构话的prompt模板约束，将这些外部知识添加到用户的问题中，并传递给语言模型。模型基于知识增强的prompt，通过自己的大量参数计算，就可以生成一个更准确的答案。</li>
</ol>
<p><img src="./images/rag-workflow.png" alt="rag-workflow"></p>
<p>当前RAG操作私有的代码仓库，在数据检索阶段，我们可以搜索到最相近的K个候选集，需要有效地对这部分候选集进行过滤。另外，检索结果的相似性要符合逻辑因果上的关联性，具体到给某个函数自动生成单元测试，函数的内部实现、类依赖、调用场景，我们希望通过检索RAG来得到。</p>
<p>说到底，本质上是 prompt工程，通过不断优化和大模型交互的prompt来提高结果的质量。有些场景下，在我们最终提问LLM之前，我们还可以优先让LLM优化一下我们的prompt，或者让LLM给出若干个优化后的prompt，人为选择最好的输出结果。</p>
<p>之前做处理大模型文生图的时，我们就前置了一次文生文的交互，目前来看，你可以做任意次数的这种交互，更像是经过一层层的干预，最后筛选出一个最优解。</p>
<p><img src="./images/n-m-llm.png" alt="n-m-llm.png"></p>
<p>基于文档和知识库的RAG问答技术，可以考虑应用到私有代码仓库。结合大模型的深度思考分析理解能力以及语法树解析，创建一个针对代码库的RAG系统，通过自然语言和代码仓库进行交互，理解项目的架构和业务实现。</p>
<p>RAG检索的流程从整体上可以分成两个环节：文本向量化和相似度计算。我们要构建的私域文本都需要经过向量化模型存储到向量数据库中，而我们做检索其实就是将问题问题向量化后，计算其与向量数据库中其它文本的相似度，选择相似度最高的文本片段。</p>
<p>对于“相似度”的理解，可以从两个角度来考虑：对称检索和非对称检索。对称检索要求查询内容和结果内容具有相近的意思；非对称检索是指根据问题召回相关答案。大模型RAG场景下的文本召回。我们通常希望的是非对称检索。</p>
<p><img src="./images/rag-flow.png" alt="rag-flow.png"></p>
<p>现在已经基本了解了RAG的概念，我们要结合LLM和RAG实现给代码生成单元测试的能力，大模型也比较适合这个场景。单元测试重点在“单元”，它涉及范围小、属于独立的代码块，大模型能够准确地理解它，只要你清晰的表达你的意图，提供准确的prompt，就可以写出非常规范的代码。</p>
<p>使用Go语言单元测试来说明，要构建prompt首先要找到准确的上下文信息，虽然是独立的函数或者方法，但和它相关的信息其实非常多，有可能涉及到很多文件或者包。比如，要给下面的方法体生成单元测试，大模型需要理解models包下的Notes结构体、dao包下的方法和PK类型、还有结构体如何实例化填充参数的问题。</p>
<p>假设我们能够将单测的这些依赖都明确的告诉LLM，那肯定是可以生成我们预期的单测结果。但关键是如何将这些信息准确的收集起来，组织好交给LLM呢？市面上有很多优秀的代码插件，耳熟能详的就有Cursor和GitHub Copilot，我们首先看看这两位选手在自动生成单元测试时，都收集了哪些代码数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UpdateNoteState</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">IContext</span>, <span style="color:#a6e22e">newNote</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">Notes</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">oldNote</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">NewNotes</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">note</span>.<span style="color:#a6e22e">GetPK</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">PK</span>(<span style="color:#a6e22e">newNote</span>.<span style="color:#a6e22e">Id</span>), <span style="color:#a6e22e">oldNote</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">oldNote</span>.<span style="color:#a6e22e">Id</span> &lt; <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">note</span>.<span style="color:#a6e22e">UpdateState</span>(<span style="color:#a6e22e">ctx</span>, int(<span style="color:#a6e22e">newNote</span>.<span style="color:#a6e22e">Id</span>), <span style="color:#a6e22e">newNote</span>.<span style="color:#a6e22e">State</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="钩子-hook">钩子 hook</h2>
<p>对于大模型的应用，我们可以重复利用两个时机来进行介入处理，其一是在真实发起调用大模型之前，其二是在拿到大模型的返回结果之后。之前看到过有 Function call，用来扩展AI的能力。</p>
<p>通过 Function Call，模型可以和外部系统进行交互集成，执行更加复杂的操作，比如提供额外的上下文、或者修复 prompt。<strong>但</strong>本质是调度，关键还在于 Call 什么，我希望可以 Call 到上面的知识库RAG</p>
<p>本文参考内容比较多，我尽量一一列举「大模型RAG实战：RAG原理、应用与系统构建」、</p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2025  渐行渐远 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">我的博客</a></li>
         
        <li><a href="/blog">技术</a></li>
         
        <li><a href="/greatperson">生活</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
